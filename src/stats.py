from telegram import Update
from telegram.ext import CallbackContext
from src.database import Database
import logging

logger = logging.getLogger(__name__)
db = Database()

def get_user_statistics(user_id: int) -> str:
    """
    –°–æ–±–∏—Ä–∞–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é:
      - –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–∑—É—á–µ–Ω–Ω—ã—Ö —Å–ª–æ–≤ (–Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç–∞–±–ª–∏—Ü—ã user_progress)
      - –ü—Ä–æ—Ü–µ–Ω—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤ (–≤ –¥–∞–Ω–Ω–æ–π –ª–æ–≥–∏–∫–µ 100%, —Ç–∞–∫ –∫–∞–∫ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –æ—Ç–≥–∞–¥–∞–Ω–Ω—ã–µ —Å–ª–æ–≤–∞)
      - –î–∏–Ω–∞–º–∏–∫–∞ –æ–±—É—á–µ–Ω–∏—è (–¥–∞–Ω–Ω—ã–µ –ø–æ–∫–∞ –Ω–µ —Å–æ–±–∏—Ä–∞—é—Ç—Å—è)
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å—Ç—Ä–æ–∫–æ–≤—ã–π –æ—Ç—á–µ—Ç.
    """
    try:
        # –ü–æ–ª—É—á–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–∑—É—á–µ–Ω–Ω—ã—Ö —Å–ª–æ–≤ –∏–∑ —Ç–∞–±–ª–∏—Ü—ã user_progress
        db.cur.execute("SELECT COUNT(*) FROM user_progress WHERE user_id = %s", (user_id,))
        learned_words = db.cur.fetchone()[0]
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –¥–ª—è user_id {user_id}: {e}")
        learned_words = 0

    # –í —Ç–µ–∫—É—â–µ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏, —Ç–∞–∫ –∫–∞–∫ –≤ —Ç–∞–±–ª–∏—Ü–µ user_progress –∑–∞–ø–∏—Å—ã–≤–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –æ—Ç–≥–∞–¥–∞–Ω–Ω—ã–µ —Å–ª–æ–≤–∞,
    # –ø—Ä–æ—Ü–µ–Ω—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤ —Å—á–∏—Ç–∞–µ—Ç—Å—è —Ä–∞–≤–Ω—ã–º 100%.
    correct_percent = 100

    stats_text = (
        f"üìä **–í–∞—à–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞**:\n\n"
        f"–í—ã –∏–∑—É—á–∏–ª–∏: **{learned_words}** —Å–ª–æ–≤(–∞).\n"
        f"–ü—Ä–æ—Ü–µ–Ω—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤: **{correct_percent}%**.\n"
        f"–î–∏–Ω–∞–º–∏–∫–∞ –æ–±—É—á–µ–Ω–∏—è: –¥–∞–Ω–Ω—ã–µ –ø–æ–∫–∞ –Ω–µ —Å–æ–±–∏—Ä–∞—é—Ç—Å—è."
    )
    return stats_text

def stats_handler(update: Update, context: CallbackContext):
    """
    –û–±—Ä–∞–±–æ—Ç—á–∏–∫, –≤—ã–∑—ã–≤–∞–µ–º—ã–π –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏.
    –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –µ–≥–æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π.
    """
    user_id = update.effective_user.id
    stats_text = get_user_statistics(user_id)
    update.message.reply_text(stats_text, parse_mode="Markdown")
